<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<style>
    .battle {
        position: relative;
        width: 100%;
        height: 400px;
        overflow: hidden;
        background-color: yellowgreen;
    }

    .castle {
        position: absolute;
        bottom: 0;
        height: 150px;
    }

    .my-castle { left: 0; }
    .enemy-castle { right: 0; }

    .nyanko, .kyonsi, .enemy {
        position: absolute;
        bottom: 0;
        height: 80px;
    }

    .castle-hp {
        position: absolute;
        top: 10px;
        left: 10px;
        color: black;
        font-size: 20px;
    }

    .money-bar {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 20px;
    }

    #spawn-neko { position:absolute; bottom:10px; left:10px; }
    #spawn-masai { position:absolute; bottom:10px; left:180px; }
</style>
</head>
<body>

<div class="battle">

    <div class="castle-hp">
        味方城HP: <span id="my-castle-hp">1000</span><br>
        敵城HP: <span id="enemy-castle-hp">1000</span>
    </div>

    <div class="money-bar">
        お金: <span id="money-value">150</span>
    </div>

    <img src="./my_castle.png" class="castle my-castle">
    <img src="./enemy_castle.png" class="castle enemy-castle">

    <button id="spawn-neko">
        にゃんこ出撃（30円）
    </button>
    <button id="spawn-masai">
        ネコキョンシー出撃（75円）
    </button>

</div>

<script>
/* -------------------------
   お金システム
-------------------------- */
let money = 150;
const moneyText = document.getElementById("money-value");

setInterval(() => {
        money += 2;
        moneyText.textContent = money;

}, 25);

/* -------------------------
   城HP
-------------------------- */
let myCastleHP = 1000;
let enemyCastleHP = 1000;

const myCastleHPText = document.getElementById("my-castle-hp");
const enemyCastleHPText = document.getElementById("enemy-castle-hp");

/* -------------------------
   出撃ボタン
-------------------------- */
const battle = document.querySelector(".battle");
const spawnNekoBtn = document.getElementById("spawn-neko");
const spawnKyonBtn = document.getElementById("spawn-masai");

spawnNekoBtn.addEventListener("click", spawnNeko);
spawnKyonBtn.addEventListener("click", spawnKyonsi);

/* -------------------------
   共通：味方キャラ生成ロジック
-------------------------- */
function createAlly(imgSrc, cssClass, hp, speed){
    const unit = document.createElement("img");
    unit.src = imgSrc;
    unit.classList.add(cssClass);
    unit.style.left = "50px";
    unit.hp = hp;

    battle.appendChild(unit);

    let pos = 50;

    const walk = setInterval(() => {
        pos += speed;
        unit.style.left = pos + "px";

        // 敵と衝突
        const enemies = document.querySelectorAll(".enemy");
        enemies.forEach(enemy => {
            const ux = unit.getBoundingClientRect().left;
            const ex = enemy.getBoundingClientRect().left;

            if(Math.abs(ux - ex) < 50){
                clearInterval(walk);
                clearInterval(enemy.walkInterval);
                battleFight(unit, enemy);
            }
        });

        // 敵城に到達
        if(pos > window.innerWidth - 200){
            clearInterval(walk);
            attackCastle("enemy");
            unit.remove();
        }
    }, 30);

    unit.walkInterval = walk;
}

/* -------------------------
   にゃんこ出撃
-------------------------- */
function spawnNeko(){
    const cost = 30;
    if(money < cost){
        alert("お金が足りない！");
        return;
    }
    money -= cost;
    moneyText.textContent = money;

    createAlly("./neko.png", "nyanko", 100, 2);
}

/* -------------------------
   ネコキョンシー出撃
-------------------------- */
function spawnKyonsi(){
    const cost = 75;
    if(money < cost){
        alert("お金が足りない！");
        return;
    }
    money -= cost;
    moneyText.textContent = money;

    createAlly("./kyonsi.png", "kyonsi", 300, 1.2);
}

/* -------------------------
   敵出現
-------------------------- */
function spawnEnemy(){
    const enemy = document.createElement("img");
    enemy.src = "./wanko.png";
    enemy.style.backgroundColor = "transparent";

    enemy.classList.add("enemy");
    enemy.style.right = "50px";
    enemy.hp = 80;

    battle.appendChild(enemy);

    let pos = 50;

    const walk = setInterval(() => {
        pos += 2;
        enemy.style.right = pos + "px";

        // 味方（にゃんこ＆キョンシー）と衝突
        const allies = document.querySelectorAll(".nyanko, .kyonsi");
        allies.forEach(ally => {
            const ax = ally.getBoundingClientRect().left;
            const ex = enemy.getBoundingClientRect().left;

            if(Math.abs(ax - ex) < 50){
                clearInterval(walk);
                clearInterval(ally.walkInterval);
                battleFight(ally, enemy);
            }
        });

        // 味方城に到達
        if(pos > window.innerWidth - 200){
            clearInterval(walk);
            attackCastle("my");
            enemy.remove();
        }
    }, 30);

    enemy.walkInterval = walk;
}

// 敵を2秒ごとに出す
setInterval(spawnEnemy, 2000);

/* -------------------------
   戦闘処理
-------------------------- */
function battleFight(ally, enemy){
    const fight = setInterval(() => {

        // 味方の攻撃力
        let allyAtk = 19;
        if(ally.classList.contains("kyonsi")){
            allyAtk = 40;   // ← キョンシーだけ攻撃力アップ
        }

        // 敵の攻撃力
        let enemyAtk = 10;

        // ダメージ処理
        ally.hp -= enemyAtk;
        enemy.hp -= allyAtk;

        // 味方死亡
        if(ally.hp <= 0){
            ally.remove();
            clearInterval(fight);
        }

        // 敵死亡
        if(enemy.hp <= 0){
            enemy.remove();
            clearInterval(fight);
        }

    }, 250); // 0.5秒ごとに攻撃
}


/* -------------------------
   城攻撃
-------------------------- */
function attackCastle(target){
    if(target === "enemy"){
        enemyCastleHP -= 100;
        enemyCastleHPText.textContent = enemyCastleHP;
        if(enemyCastleHP <= 0) documnet.while("完全勝利")
    } else {
        myCastleHP -= 100;
        myCastleHPText.textContent = myCastleHP;
        if(myCastleHP <= 0) alert("敗北…");
    }
}
</script>

</body>
</html>
